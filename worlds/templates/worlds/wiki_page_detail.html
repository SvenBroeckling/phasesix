{% extends 'base.html' %}
{% load static i18n characters_extras rules_extras thumbnail world_extras %}

{% block javascript %}
    <script src="{% static 'js/worlds_detail.js' %}"></script>
    <script>
    $(function(){
        let masonry = $('.masonry-container').masonry()
        setTimeout(function(){
            masonry.masonry('layout')
        }, 1000)
    })
    </script>
{% endblock %}

{% block title %}{{ object }} - {{ block.super }}{% endblock %}

{% block belownav %}
    <div
        {% with img=object.get_image %}
            {% if img %}
                {% thumbnail img.image '1024' as im %}
                    style="position: relative; height: 36vh; background-image: url({{ im.url }})"
                {% endthumbnail %}
            {% endif %}
                class="row character-info-row mb-3">
        {% endwith %}

        <div class="col-md-10 offset-md-1 d-flex justify-content-between pb-5">
            <div>
                <h1>{{ object }}</h1>
            </div>
        </div>

        <span class="background-image-copyright">
            {% with img=object.get_image %}
                {% if img %}
                    Image by <a href="{{ img.copyright_url }}">{{ img.copyright }}</a>
                {% endif %}
            {% endwith %}
        </span>

    </div>
{% endblock %}

{% block content %}
        <div class="row mt-2">
            <div class="col-12">

                {% breadcrumbs object as crumbs %}
                <div class="float-md-start">
                    <nav aria-label="breadcrumbs">
                        <ol class="breadcrumb">
                            {% for bc in crumbs %}
                                <li class="breadcrumb-item"><a href="{{ bc.1 }}">{{ bc.0 }}</a></li>
                            {% endfor %}
                        </ol>
                    </nav>
                </div>

                {% if may_edit %}
                <a
                        class="btn btn-warning float-end modal-trigger"
                        title="{% trans 'Edit Page' %}"
                        href="{% url 'world:edit_text' world_slug=object.world.slug slug=object.slug %}"><i class="fa fa-pen"></i> {% trans 'Edit Page' %}</a>
                <a
                        class="btn btn-warning me-md-1 mt-1 mt-md-0 float-end modal-trigger"
                        data-url="{% url 'world:xhr_create_wiki_page' world_pk=object.world.id parent_pk=object.id %}"
                        title="{% trans 'Create Wiki Page' %}"
                        data-bs-toggle="modal"
                        data-modal-title="{% trans 'Create Wiki Page' %}"
                        data-bs-target=".page-modal"
                        href=""><i class="fa fa-plus"></i> {% trans 'Create Subpage' %}</a>
                {% endif %}
            </div>
        </div>

    <div class="row mt-4">
        <div class="col-12 wiki-page">
            {{ object.text|urpg_markup|replace_tags:object.world }}
        </div>
    </div>

    <div class="row masonry-container mt-4">
        {% for page in object.wikipage_set.all %}
            <div class="col col-md-4">
                <a class="invisible-link" href="{% url 'world:wiki_page' world_slug=object.world.slug slug=page.slug %}">
                    <div class="card pointer mb-4">
                        <div class="card-header">
                            {{ page }}
                        </div>
                        {% if page.image %}
                            {% thumbnail page.image "1024" as im %}
                                <img src="{{ im.url }}" class="card-img-top" alt="{{ page }}">
                            {% endthumbnail %}
                        {% endif %}
                        <div class="card-body">
                            {{ page.text|to_first_linebreak|urpg_markup|replace_tags:page.world }}
                        </div>
                        {% if user.is_superuser %}
                            <a href="{% url 'admin:worlds_wikipage_change' page.id %}"
                               style="position: absolute; bottom: 2px; right: 2px; font-size: xx-small">admin</a>
                        {% endif %}
                    </div>
                </a>
            </div>
        {% endfor %}
    </div>
{% endblock %}