{% extends 'base.html' %}
{% load static i18n characters_extras rules_extras thumbnail world_extras %}

{% block javascript %}
    <script src="{% static 'js/worlds_detail.js' %}"></script>
    <script>
        $(function () {
            let masonry = $('.masonry-container').masonry()
            setTimeout(function () {
                masonry.masonry('layout')
            }, 1000)
        })
    </script>
{% endblock %}

{% block title %}{{ object }} - {{ block.super }}{% endblock %}

{% block background %}{% thumbnail object.get_image.image "1900" as im %}{{ im.url }}{% endthumbnail %}{% endblock %}

{% block background_copyright %}
    Image by <a href="{{ object.get_image.copyright_url }}">{{ object.get_image.copyright }}</a>
{% endblock %}

{% block opengraph %}
    <meta property="og:title" content="Phase Six - {{ object }}"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://phasesix.org"/>
    {% if object.image %}
        {% thumbnail object.image '600' as image %}
            <meta property="og:image" content="https://phasesix.org{{ image.url }}"/>
        {% endthumbnail %}
    {% endif %}
    <meta property="og:description" content="{{ object.text|to_first_linebreak }}"/>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-12 col-sm-4 col-md-3">

            <div class="card">
                {% with img=object.get_image %}
                    {% if img %}
                        {% thumbnail img.image '1024' as im %}
                            <img class="card-img-top rounded" src="{{ im.url }}" alt="{{ object }}"/>
                        {% endthumbnail %}
                    {% endif %}
                {% endwith %}
            </div>

            {% for game_values in object.wikipagegamevalues_set.all %}
                <div class="row mt-3 mb-0">
                    <div class="col-12 text-center">
                        <h5>{% trans 'Game Values' %}</h5>
                    </div>
                </div>

                <div class="row wiki-page-game-values">
                    <div class="col-12 mt-1">
                        {% trans 'Type' %}
                        <span class="float-end">{{ game_values.type }}</span>
                    </div>
                    <div class="col-12 mt-1">
                        {% trans 'Wounds' %}
                        <span class="float-end">{% color_value_span game_values.health 6 %}</span>
                    </div>
                    <div class="col-12 mt-1">
                        {% trans 'Arcana' %}
                        <span class="float-end">{% color_value_span game_values.arcana 6 %}</span>
                    </div>
                    <div class="col-12 mt-1">
                        {% trans 'Protection' %}
                        <span class="float-end">{% color_value_span game_values.protection 3 %}</span>
                    </div>
                    <div class="col-12 mt-1">
                        {% trans 'Actions' %}
                        <span class="float-end">{% color_value_span game_values.actions 3 %}</span>
                    </div>
                    <div class="col-12 mt-1">
                        {% trans 'Quickness' %}
                        <span class="float-end">{% color_value_span game_values.quickness 3 %}</span>
                    </div>
                    <div class="col-12 mt-1">
                        {% trans 'Minimum Roll' %}
                        <span class="float-end">{% color_value_span game_values.minimum_roll 5 invert=True %}</span>
                    </div>
                    <div class="col-12 mt-1">
                        {% trans 'Resistances' %}
                        <span class="float-end">{{ game_values.resistance_string }}</span>
                    </div>
                    <div class="col-12 mt-1">
                        {% trans 'Weaknesses' %}
                        <span class="float-end">{{ game_values.weakness_string }}</span>
                    </div>
                </div>
            {% endfor %}

            {% if object.wikipagegameaction_set.exists %}
                <div class="row mt-3 mb-0">
                    <div class="col-12 text-center">
                        <h5>{{ object.actions_heading|default:"Actions" }}</h5>
                    </div>
                </div>
                {% for action in object.wikipagegameaction_set.all %}
                    <div
                        tabindex="0"
                        role="button"
                        data-bs-toggle="popover"
                        data-bs-custom-class="custom-popover"
                        data-bs-trigger="hover"
                        data-bs-title="{{ action.name }}"
                        data-bs-content="{{ action.effect|urpg_markup }}"
                        class="row wiki-page-game-values">
                        <div class="col-12">
                            {{ action.name }}
                            <span class="float-end">{% color_value_span action.skill 5 %}</span>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="col-12 col-sm-8 col-md-9 mt-3 mt-md-0 wiki-page">

            {% if may_edit %}
                <div class="btn-group dropdown-center float-end">
                    <a class="btn btn-primary"
                       href="{% url 'world:edit_text' world_slug=object.world.slug slug=object.slug %}"
                       role="button"><i class="fas fa-pen"></i> {% trans 'Edit' %}</a>
                    <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="visually-hidden">Toggle Dropdown</span>
                    </button>

                    <div class="dropdown-menu">
                        <a
                            class="dropdown-item modal-trigger"
                            data-url="{% url 'world:xhr_create_wiki_page' world_pk=object.world.id parent_pk=object.id %}"
                            title="{% trans 'Create Wiki Page' %}"
                            data-bs-toggle="modal"
                            data-modal-title="{% trans 'Create Wiki Page' %}"
                            data-bs-target=".page-modal"
                            href=""><i class="fa fa-plus"></i> {% trans 'Create Subpage' %}</a>
                        <a
                            data-sidebar-url="{% url 'worlds:xhr_wiki_page_sort_sidebar' slug=object.slug sidebar_template="sort_sub_pages" %}"
                            data-sidebar-title="{% trans 'Sort Subpages' %}"
                            class="dropdown-item sidebar-trigger">
                            <i class="fa fa-sort"></i> {% trans 'Sort Subpages' %}
                        </a>
                        {% if user.is_superuser %}
                            <a class="dropdown-item" href="{% url 'admin:worlds_wikipage_change' object.id %}"><i
                                class="fas fa-lock"></i> {% trans 'Admin' %}</a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <h1>{{ object.name }}</h1>

            <nav aria-label="breadcrumbs" style="--bs-breadcrumb-divider: '>';">
                <ol class="breadcrumb">
                    {% breadcrumbs object as crumbs %}
                    {% for bc in crumbs %}
                        <li class="breadcrumb-item"><a href="{{ bc.1 }}">{{ bc.0 }}</a></li>
                    {% endfor %}
                </ol>
            </nav>

            {{ object.text|urpg_markup|replace_tags:object.world }}
        </div>
    </div>

    <div class="row masonry-container mt-4">
        {% for page in object.wikipage_set.all %}
            <div class="col col-md-6 col-xl-4">
                <a class="invisible-link"
                   href="{% url 'world:wiki_page' world_slug=object.world.slug slug=page.slug %}">
                    <div class="card pointer mb-4">
                        <div class="card-header">
                            {{ page }}
                        </div>
                        {% if page.image %}
                            {% thumbnail page.image "1024" as im %}
                                <img src="{{ im.url }}" class="card-img-top" alt="{{ page }}">
                            {% endthumbnail %}
                        {% endif %}
                        <div class="card-body">
                            {{ page.text|to_first_linebreak|urpg_markup|replace_tags:page.world }}
                        </div>
                        {% if user.is_superuser %}
                            <a href="{% url 'admin:worlds_wikipage_change' page.id %}"
                               style="position: absolute; bottom: 2px; right: 2px; font-size: xx-small">admin</a>
                        {% endif %}
                    </div>
                </a>
            </div>
        {% endfor %}
    </div>
{% endblock %}
