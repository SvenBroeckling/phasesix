{% load rules_extras %}
{% load characters_extras %}
{% load i18n %}
{% for weapon in object.characterweapon_set.all %}
    <div class="weapon-sortable"
         data-url="{% url 'characters:xhr_update_item_sort_order' pk=character.id %}">
        <div class="card mb-4 sidebar-trigger" data-sidebar-title="{{ weapon.weapon }}"
             data-sidebar-url="{% url 'characters:xhr_characterweapon_sidebar' pk=weapon.id sidebar_template="characterweapon" %}">
            <div class="card-header">
                {{ weapon.weapon }} <span class="small text-muted">{{ weapon.weapon.type }}</span>
                {% if weapon.modified_concealment > 0 %}
                    <span class="float-end">
                                    <i class="fas fa-eye-slash fa-fw"
                                       title="{% trans 'Concealment' %}"></i> {% color_value_span weapon.modified_concealment 7 invert=True %}
                                </span>
                {% endif %}
                {% if weapon.condition < 100 %}
                    <span class="float-end me-1">
                                    <span title="{% trans 'Condition' %}">{% color_value_span weapon.condition 100 %}%</span>
                                </span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        {{ weapon.weapon.description|urpg_markup }}
                        <i class="fas fa-angle-double-right fa-fw text-muted"></i> {% trans 'Piercing' %}: {% color_value_span weapon.weapon.piercing 4 %} {% display_modifications weapon 'piercing' %}<br>
                        <i class="fas fa-dice-five fa-fw text-muted"></i> {% trans 'Damage Potential' %}: {% for i in weapon.weapon.damage_potential|to_range %}<i class="fas fa-fw fa-dice-six text-success" title="{% trans 'Damage Potential' %}"></i>{% empty %}-{% endfor %} {% display_modifications weapon 'damage_potential' %}<br>
                        {% if weapon.modified_recoil_compensation %}
                            <i class="fas fa-arrow-down fa-fw text-muted"></i> {% trans 'Recoil Compensation' %}: {% color_value_span weapon.weapon.recoil_compensation 3 %} {% display_modifications weapon 'recoil_compensation' %}<br>
                        {% endif %}
                        <i class="fas fa-clock fa-fw text-muted"></i> {% trans 'Actions to ready' %}: {% color_value_span weapon.weapon.actions_to_ready 4 %} {% display_modifications weapon 'actions_to_ready' %}<br>
                        {% if weapon.has_capacity %}
                            <i class="fas fa-clock fa-fw text-muted"></i> {% trans 'Reload actions' %}:
                            {% color_value_span weapon.weapon.reload_actions 6 invert=True %}
                            {% display_modifications weapon 'reload_actions' %}<br>
                            <i class="fas fa-list-ol fa-fw text-muted"></i> {% trans 'Capacity' %}:
                            {% color_value_span weapon.weapon.capacity 30 %}
                            {% display_modifications weapon 'capacity' %}<br>
                        {% endif %}
                        <i class="fas fa-arrows-alt-h fa-fw text-muted"></i> {% trans 'Range' %}: {{ weapon.weapon.range_meter }}m {% display_modifications weapon 'range_meter' %}<br>
                        <i class="fas fa-weight fa-fw text-muted"></i> {% trans 'Encumbrance' %}: {% color_value_span weapon.weapon.encumbrance 2 invert=True %} {% display_modifications weapon 'encumbrance' %}<br>
                        <br>

                        {% for fm in weapon.weapon.weaponattackmode_set.all %}
                            {{ fm.attack_mode.name }}<br>
                        {% endfor %}

                        {% if weapon.modifications.exists %}
                            <div class="row mt-3">
                                {% for wm in weapon.modifications.all %}
                                    <div class="col-6">
                                        <div class="card mb-2">
                                            <div class="card-header">
                                                <i class="fas fa-puzzle-piece"></i>
                                                {{ wm }}
                                            </div>
                                            <div class="card-body">
                                                {% if wm.rules %}
                                                    <p>
                                                        {{ wm.rules|urpg_markup }}
                                                    </p>
                                                {% endif %}
                                                {% for wma in wm.weaponmodificationattributechange_set.all %}
                                                    {{ wma.get_attribute_display|capfirst }} +
                                                    {% color_value_span wma.attribute_modifier 4 %}<br>
                                                {% endfor %}
                                                {% for wma in wm.weaponmodificationattributechange_set.all %}
                                                    {% if wma.status_effect %}
                                                        {{ wma.status_effect|capfirst }}
                                                        <i class="{{ wma.status_effect.fa_icon_class }}"></i>
                                                        {% color_value_span wma.status_effect_value 4 %}<br>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% if user.is_superuser %}
                    <a href="{% url 'admin:armory_weapon_change' weapon.weapon.id %}"
                       style="position: absolute; bottom: 2px; right: 2px; font-size: xx-small">admin</a>
                {% endif %}
            </div>
        </div>
    </div>
{% empty %}
    {% if may_edit %}
        <div class="card mb-4">
            <div class="card-body">
                <a
                    class="modal-trigger"
                    data-url="{% url 'characters:xhr_add_weapons' pk=object.id %}"
                    {% if may_edit %}
                    data-bs-toggle="modal"
                    {% endif %}
                    data-bs-target=".page-modal"
                    data-modal-title="{% trans 'Add Weapon' %}"
                    href="">{% trans 'No weapon yet.' %}</a>

            </div>
        </div>
    {% endif %}
{% endfor %}
