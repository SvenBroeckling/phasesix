{% extends 'characters/fragments/fragment_base.html' %}
{% load characters_extras rules_extras i18n %}

{% block fragment %}

    <div class="row">
        <div class="col-md-6">
            <div>
                {% if may_edit %}
                    <a
                            class="btn btn-primary btn-sm float-end modal-trigger"
                            data-url="{% url 'characters:xhr_add_riot_gear' pk=object.id %}"
                            data-bs-toggle="modal"
                            data-bs-target=".page-modal"
                            data-modal-title="{% trans 'Add Armor' %}"
                            href=""><i class="fas fa-plus"></i> {% trans 'Add' %}</a>
                    {% if user.is_authenticated %}
                        <a
                                class="btn btn-warning btn-sm float-end me-1 modal-trigger"
                                data-url="{% url 'homebrew:xhr_create_riot_gear' character_pk=object.id %}"
                                data-bs-toggle="modal"
                                data-bs-target=".page-modal"
                                data-modal-title="{% trans 'Create Armor' %}"
                                href=""><i class="fas fa-plus"></i> {% trans 'Create' %}</a>
                    {% endif %}
                {% endif %}
                <h2 class="mb-2 h4">{% trans 'Armor' %}</h2>
            </div>

            {% for r in character.characterriotgear_set.all %}
                <div class="card mb-4 sidebar-trigger" data-sidebar-title="{{ r.riot_gear }}"
                     data-sidebar-url="{% url 'characters:xhr_characterriotgear_sidebar' pk=r.id sidebar_template="characterriotgear" %}">
                    <div class="card-header">
                        {{ r.riot_gear }} <span class="small text-muted">{{ r.riot_gear.type }}</span>
                        {% if r.riot_gear.concealment > 0 %}
                            <span class="float-end">
                                <i class="fas fa-eye-slash fa-fw"
                                   title="{% trans 'Concealment' %}"></i> {% color_value_span r.riot_gear.concealment 6 invert=True %}
                            </span>
                        {% endif %}
                        {% if r.condition < 100 %}
                            <span class="float-end me-1">
                                <span title="{% trans 'Condition' %}">{% color_value_span r.condition 100 %}%</span>

                            </span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <i class="fas fa-shield-alt fa-fw"></i> {% trans 'Protection' %}: {% color_value_span r.riot_gear.protection_ballistic 3 %}<br>
                        <i class="fas fa-weight fa-fw"></i> {% trans 'Encumbrance' %}: {% color_value_span r.riot_gear.encumbrance 6 invert=True %}<br>
                        {% if user.is_superuser %}
                            <a href="{% url 'admin:armory_riotgear_change' r.riot_gear.id %}"
                               style="position: absolute; bottom: 2px; right: 2px; font-size: xx-small">admin</a>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                {% if may_edit %}
                    <div class="card mb-4">
                        <div class="card-body">
                            <a
                                    class="modal-trigger"
                                    data-url="{% url 'characters:xhr_add_riot_gear' pk=object.id %}"
                                    {% if may_edit %}
                                    data-bs-toggle="modal"
                                    {% endif %}
                                    data-bs-target=".page-modal"
                                    data-modal-title="{% trans 'Add Armor' %}"
                                    href="">{% trans 'No armor yet.' %}</a>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}

            <div>
                {% if may_edit %}
                    <a
                            class="btn btn-primary btn-sm float-end modal-trigger"
                            data-url="{% url 'characters:xhr_add_weapons' pk=object.id %}"
                            data-bs-toggle="modal"
                            data-bs-target=".page-modal"
                            data-modal-title="{% trans 'Add Weapon' %}"
                            href=""><i class="fas fa-plus"></i> {% trans 'Add' %}</a>
                    {% if user.is_authenticated %}
                        <a
                                class="btn btn-warning btn-sm me-1 float-end modal-trigger"
                                data-url="{% url 'homebrew:xhr_create_weapon' character_pk=object.id %}"
                                data-bs-toggle="modal"
                                data-bs-target=".page-modal"
                                data-modal-title="{% trans 'Create Weapon' %}"
                                href=""><i class="fas fa-plus"></i> {% trans 'Create' %}</a>
                    {% endif %}
                {% endif %}
                <h2 class="mb-2 h4">{% trans 'Weapons' %}</h2>
            </div>

            {% for weapon in object.characterweapon_set.all %}
                <div class="weapon-sortable"
                     data-url="{% url 'characters:xhr_update_item_sort_order' pk=character.id %}">
                    <div class="card mb-4 sidebar-trigger" data-sidebar-title="{{ weapon.weapon }}"
                         data-sidebar-url="{% url 'characters:xhr_characterweapon_sidebar' pk=weapon.id sidebar_template="characterweapon" %}">
                        <div class="card-header">
                            {{ weapon.weapon }} <span class="small text-muted">{{ weapon.weapon.type }}</span>
                            {% if weapon.modified_concealment > 0 %}
                                <span class="float-end">
                                    <i class="fas fa-eye-slash fa-fw"
                                       title="{% trans 'Concealment' %}"></i> {% color_value_span weapon.modified_concealment 7 invert=True %}
                                </span>
                            {% endif %}
                            {% if weapon.condition < 100 %}
                                <span class="float-end me-1">
                                    <span title="{% trans 'Condition' %}">{% color_value_span weapon.condition 100 %}%</span>
                                </span>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12">
                                    {{ weapon.weapon.description|urpg_markup }}
                                    <i class="fas fa-angle-double-right fa-fw text-muted"></i> {% trans 'Piercing' %}: {% color_value_span weapon.weapon.piercing 4 %} {% display_modifications weapon 'piercing' %}<br>
                                    <i class="fas fa-dice-five fa-fw text-muted"></i> {% trans 'Damage Potential' %}: {% for i in weapon.weapon.damage_potential|to_range %}<i class="fas fa-fw fa-dice-six text-success" title="{% trans 'Damage Potential' %}"></i>{% empty %}-{% endfor %} {% display_modifications weapon 'damage_potential' %}<br>
                                    <i class="fas fa-clock fa-fw text-muted"></i> {% trans 'Actions to ready' %}: {% color_value_span weapon.weapon.actions_to_ready 4 %} {% display_modifications weapon 'actions_to_ready' %}<br>
                                    {% if weapon.has_capacity %}
                                        <i class="fas fa-clock fa-fw text-muted"></i> {% trans 'Reload actions' %}:
                                        {% color_value_span weapon.weapon.reload_actions 6 invert=True %}
                                        {% display_modifications weapon 'reload_actions' %}<br>
                                        <i class="fas fa-list-ol fa-fw text-muted"></i> {% trans 'Capacity' %}:
                                        {% color_value_span weapon.weapon.capacity 30 %}
                                        {% display_modifications weapon 'capacity' %}<br>
                                    {% endif %}
                                    <i class="fas fa-arrows-alt-h fa-fw text-muted"></i> {% trans 'Range' %}: {{ weapon.weapon.range_meter }}m {% display_modifications weapon 'range_meter' %}<br>
                                    <i class="fas fa-weight fa-fw text-muted"></i> {% trans 'Encumbrance' %}: {% color_value_span weapon.weapon.encumbrance 2 invert=True %} {% display_modifications weapon 'encumbrance' %}<br>
                                    <br>

                                    {% for fm in weapon.weapon.weaponattackmode_set.all %}
                                        {{ fm.attack_mode.name }}<br>
                                    {% endfor %}

                                    {% if weapon.modifications.exists %}
                                        <div class="row mt-3">
                                            {% for wm in weapon.modifications.all %}
                                                <div class="col-6">
                                                    <div class="card mb-2">
                                                        <div class="card-header">
                                                            <i class="fas fa-puzzle-piece"></i>
                                                            {{ wm }}
                                                        </div>
                                                        <div class="card-body">
                                                            {% if wm.rules %}
                                                                <p>
                                                                    {{ wm.rules|urpg_markup }}
                                                                </p>
                                                            {% endif %}
                                                            {% for wma in wm.weaponmodificationattributechange_set.all %}
                                                                {{ wma.get_attribute_display|capfirst }} +
                                                                {% color_value_span wma.attribute_modifier 4 %}<br>
                                                            {% endfor %}
                                                            {% for wma in wm.weaponmodificationattributechange_set.all %}
                                                                {% if wma.status_effect %}
                                                                    {{ wma.status_effect|capfirst }}
                                                                    <i class="{{ wma.status_effect.fa_icon_class }}"></i>
                                                                    {% color_value_span wma.status_effect_value 4 %}<br>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% if user.is_superuser %}
                                <a href="{% url 'admin:armory_weapon_change' weapon.weapon.id %}"
                                   style="position: absolute; bottom: 2px; right: 2px; font-size: xx-small">admin</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                {% if may_edit %}
                    <div class="card mb-4">
                        <div class="card-body">
                            <a
                                    class="modal-trigger"
                                    data-url="{% url 'characters:xhr_add_weapons' pk=object.id %}"
                                    {% if may_edit %}
                                    data-bs-toggle="modal"
                                    {% endif %}
                                    data-bs-target=".page-modal"
                                    data-modal-title="{% trans 'Add Weapon' %}"
                                    href="">{% trans 'No weapon yet.' %}</a>

                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="col-md-6">
            <div>
                {% if may_edit %}
                    <a
                            class="btn btn-primary btn-sm float-end modal-trigger"
                            data-url="{% url 'characters:xhr_add_items' pk=object.id %}"
                            title="{% trans 'Add Item' %}"
                            data-bs-toggle="modal"
                            data-modal-title="{% trans 'Add item' %}"
                            data-bs-target=".page-modal"
                            href=""><i class="fa fa-plus"></i> {% trans 'Add' %}</a>
                    {% if user.is_authenticated %}
                        <a
                                class="btn btn-warning btn-sm me-1 float-end modal-trigger"
                                data-url="{% url 'homebrew:xhr_create_item' character_pk=object.id %}"
                                title="{% trans 'Create Item' %}"
                                data-bs-toggle="modal"
                                data-modal-title="{% trans 'Create item' %}"
                                data-bs-target=".page-modal"
                                href=""><i class="fa fa-plus"></i> {% trans 'Create' %}</a>
                    {% endif %}
                {% endif %}
                <h2 class="mb-2 h4">{% trans 'Items' %}</h2>
            </div>

            {% if object.currency_map %}
                <div class="card mb-3 sidebar-trigger" data-sidebar-title="{% trans 'Currency' %}"
                     data-sidebar-url="{% url 'characters:xhr_character_sidebar' pk=object.id sidebar_template="currency" %}">
                    <div class="card-body text-center">
                        {% for unit in object.currency_map.currencymapunit_set.all %}
                            <i class="ms-1 {{ unit.fa_icon_class }} {{ unit.color_class }}"></i>
                            {{ object|currency_quantity:unit }}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <div class="card">
                <div class="card-header">{% trans 'On Body' %}</div>
                <div class="card-body">
                    {% include 'characters/fragments/_gear_item.html' with qs=character.characteritem_set.not_in_container.without_containers %}
                </div>
            </div>

            {% for container in character.characteritem_set.containers %}
                <div class="card mt-3 sidebar-trigger"
                     data-pk="container.id"
                     data-sidebar-url="{% url 'characters:xhr_characteritem_sidebar' pk=container.id sidebar_template="characteritem" %}"
                     data-sidebar-title="{{ container.item }}">
                    <div class="card-header">{{ container.item }}</div>
                    <div class="card-body">
                        {% include 'characters/fragments/_gear_item.html' with qs=container.characteritem_set.without_containers %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}
